# Production Mainnet Demo Guide

Complete guide to running the agentkit demo with real USDC on Base mainnet.

## Overview

This demo proves the complete value flow:
- **Agent pays** 0.2 USDC for MCP research tools
- **Merchant receives** 0.2 USDC in their wallet
- **All transactions** recorded on Base blockchain

## Prerequisites

### 1. Agent Wallet Setup

Your agent wallet needs:
- **1-2 USDC** on Base mainnet (for app session)
- **0.001 ETH** on Base mainnet (for gas fees)

Check your current balance:
```bash
npx tsx scripts/check-base-balance.ts
```

### 2. How to Get Funds on Base

**Option A: Buy on Coinbase (Easiest)**
1. Buy USDC on Coinbase
2. Withdraw to Base network (select "Base" not "Ethereum")
3. Send to your agent address from `.env`
4. Also buy small amount of ETH and send to Base

**Option B: Bridge from Ethereum**
1. Visit https://bridge.base.org
2. Bridge USDC and ETH to Base
3. Costs ~$10-20 in Ethereum gas fees

**Cost Estimate:**
- USDC needed: 1-2 USDC (~$1-2)
- Gas fees: 0.001 ETH (~$2-3)
- **Total: ~$3-5 USD**

### 3. Environment Configuration

Your `.env` must have:
```bash
YELLOW_AGENT_PRIVATE_KEY=0x...      # Auto-generated by npm run setup
YELLOW_AGENT_ADDRESS=0x...          # Auto-generated
YELLOW_MERCHANT_PRIVATE_KEY=0x...   # Auto-generated
YELLOW_MERCHANT_ADDRESS=0x...       # Auto-generated
```

No need to set `YELLOW_CLEARNODE_URL` - it auto-detects production vs sandbox.

## Quick Start (Automated)

Run the complete demo with one command:

```bash
npm run demo:production
```

This will:
1. Check starting balances
2. Run agentkit demo (creates session, pays merchant)
3. Merchant offramp (withdraws to wallet)
4. Show final balances with Basescan links

## Step-by-Step Manual Flow

If you prefer to run each step manually:

### Step 1: Check Balances

```bash
npx tsx scripts/check-base-balance.ts
```

Verify agent has sufficient USDC and ETH.

### Step 2: Run Agentkit Demo (Production Mode)

```bash
YELLOW_ENV=production npm run demo:agentkit
```

**What happens:**
1. Agent creates Yellow Network app session (1 USDC locked)
2. Agent authenticates with SIWx (wallet signature)
3. Agent queries `stock_price` tool (0.1 USDC)
4. Agent queries `market_rumors` tool (0.1 USDC)
5. Session closes with quorum 2 settlement
6. Merchant receives 0.2 USDC (in unified balance)
7. Agent gets 0.8 USDC refund

**Expected output:**
```
=== Network Configuration ===
Mode: PRODUCTION
Clearnode: wss://clearnet.yellow.com/ws
Asset: usdc
Blockchain: base (chainId: eip155:8453)
Agent: 0x...
Merchant: 0x...

--- Step 1: Agent Creates Yellow Session (Quorum 2) ---
Yellow session created: 0x...
Both agent and merchant signed (Quorum 2)

--- Step 2: Agent Signs SIWx Challenge ---
[AI Agent] Wallet authenticated via SIWx

--- Step 3: Agent Queries Stock Price ---
Stock data received
Transaction: 0.1 usdc deducted from session

--- Step 4: Agent Queries Market Sentiment ---
Sentiment data received
Session reused - no additional payment

--- Step 5: Agent Makes Trade Decision ---
Research complete. Trade decision: BUY

--- Step 6: Close Session (Merchant Payment) ---
Session closed with Quorum 2
Merchant received: 0.2 usdc
Agent refunded: 0.8 usdc

--- Step 7: Merchant Offramp (Withdraw to On-Chain) ---
SUCCESS: Merchant offramp successful!
```

### Step 3: Merchant Withdraws to Wallet

```bash
npm run merchant-offramp -- base
```

**What happens:**
1. Check merchant unified balance (should have 0.2 USDC)
2. Create payment channel
3. Move unified balance to channel
4. Close channel (settles to custody ledger)
5. Withdraw from custody to merchant wallet
6. Generate Basescan transaction links

**Expected output:**
```
=== Merchant On-Chain Offramp ===
Merchant: 0x...
Network: Base (PRODUCTION)

Step 1/7: Checking unified balance...
SUCCESS: Unified balance: 0.2 usdc

Step 2/7: Initializing blockchain client...
SUCCESS: Nitrolite client initialized

Step 3/7: Connecting and authenticating...
SUCCESS: Authenticated

Step 4/7: Checking for payment channels...
SUCCESS: Found existing channel: 0x...

Step 5/7: Moving unified balance to channel...
SUCCESS: Resize prepared

Step 6/7: Closing channel (settlement to custody)...
SUCCESS: Channel closed on-chain!
TX Hash: 0x...
Explorer: https://basescan.org/tx/0x...

Step 7/7: Withdrawing from custody to wallet...
SUCCESS: Funds withdrawn to wallet!
TX Hash: 0x...
Explorer: https://basescan.org/tx/0x...

=== Offramp Summary ===
Amount: 0.2 usdc
From: Yellow Network Unified Balance (off-chain)
To: 0x... (Base wallet)
```

### Step 4: Verify Final State

```bash
npx tsx scripts/check-base-balance.ts
```

**Expected changes:**
- Agent wallet: -0.2 USDC (paid for tools), -0.001 ETH (gas)
- Merchant wallet: +0.2 USDC (received payment), -0.001 ETH (gas for offramp)

## Architecture Flow

```
┌──────────────────────────────────────────────────────────────┐
│                    PRODUCTION FLOW                            │
└──────────────────────────────────────────────────────────────┘

1. Agent Wallet (Base)
   - Has 1 USDC + 0.001 ETH
   - Ready to pay for research
   │
   ↓ (creates app session)
   │
2. Yellow Network App Session
   - Agent locks 1 USDC
   - Quorum 2: Agent + Merchant signatures required
   - Off-chain payment channel
   │
   ↓ (uses MCP tools)
   │
3. MCP Server (x402 + SIWx)
   - Verifies wallet signature (SIWx)
   - Deducts from session: 0.1 per tool
   - Returns financial data
   │
   ↓ (session closes)
   │
4. Settlement (Quorum 2)
   - Agent receives 0.8 USDC refund
   - Merchant receives 0.2 USDC payment
   - Both parties sign final state
   │
   ↓ (merchant unified balance)
   │
5. Merchant Unified Balance
   - Off-chain ledger: 0.2 USDC
   - Instant settlement
   │
   ↓ (offramp process)
   │
6. Payment Channel Bridge
   - Create channel
   - Move unified → channel
   - Close channel → custody
   │
   ↓ (withdrawal)
   │
7. Merchant Wallet (Base)
   - Receives 0.2 USDC
   - Basescan transaction proof
   - Can withdraw to fiat via exchange
```

## Troubleshooting

### Error: Insufficient balance

**Problem:** Agent doesn't have enough USDC or ETH

**Solution:**
1. Check balances: `npx tsx scripts/check-base-balance.ts`
2. Add funds to agent wallet on Base network
3. Retry

### Error: Session creation failed

**Problem:** Yellow Network connection issue

**Solution:**
1. Check clearnode is responding: `curl https://clearnet.yellow.com/health`
2. Verify private keys are correct in `.env`
3. Check Yellow Network status: https://status.yellow.org

### Error: Merchant offramp failed

**Problem:** Unified balance → custody bridge issue

**Solution:**
1. Check merchant actually has unified balance
2. Wait 30 seconds and retry (indexing delay)
3. If still failing, merchant can:
   - Keep funds in unified balance
   - Use for future payments
   - Transfer to another Yellow account

### Error: Gas estimation failed

**Problem:** Not enough ETH for gas

**Solution:**
1. Send 0.002 ETH to agent wallet on Base
2. Retry transaction

## Production vs Sandbox Differences

| Aspect | Sandbox | Production |
|--------|---------|------------|
| Network | Sepolia testnet | Base mainnet |
| Asset | ytest.usd (test token) | usdc (real USDC) |
| Clearnode | `wss://clearnet-sandbox.yellow.com/ws` | `wss://clearnet.yellow.com/ws` |
| ChainId | eip155:84532 | eip155:8453 |
| Funding | Yellow faucet (free) | Buy USDC ($) |
| Value | No real money | Real money |
| Explorer | sepolia.etherscan.io | basescan.org |

## Environment Variables for Production

To force production mode, set:

```bash
export YELLOW_ENV=production
```

Or inline:

```bash
YELLOW_ENV=production npm run demo:agentkit
```

The system auto-detects based on:
1. `YELLOW_ENV` environment variable
2. `YELLOW_CLEARNODE_URL` (if contains "sandbox" → sandbox mode)
3. Default: sandbox for safety

## Cost Breakdown

**One complete demo run:**

| Item | Cost |
|------|------|
| Agent session lock | 1 USDC (gets 0.8 back) |
| Stock price query | 0.1 USDC |
| Market rumors query | 0.1 USDC |
| Gas fees (agent) | ~0.0005 ETH (~$1) |
| Gas fees (merchant offramp) | ~0.0005 ETH (~$1) |
| **Net cost** | **0.2 USDC + ~$2 gas** |

Merchant receives: 0.2 USDC in wallet

## What This Proves

### Technical Architecture
- SIWx authentication works (wallet-based auth)
- Yellow Network app sessions work (off-chain payments)
- Quorum 2 settlement works (multi-sig governance)
- Unified balance offramp works (off-chain -> on-chain)
- Real blockchain integration (Base mainnet)

### Economic Flow
- Agent can pay for AI services with crypto
- Merchant receives real money in wallet
- All transactions have blockchain proof
- System handles production traffic

### Production Readiness
- Works with real money
- Proper error handling
- Transaction receipts and proof
- Suitable for actual deployment

## Next Steps

After successful demo:

1. **For Developers:**
   - Deploy MCP server to production
   - Set up monitoring and alerts
   - Configure pricing for your tools
   - Document merchant settlement process

2. **For Merchants:**
   - Decide on withdrawal strategy:
     - Keep in unified balance for instant settlement
     - Batch withdrawals to save gas
     - Set up automated offramp schedule

3. **For Agents:**
   - Integrate with your AI agent framework
   - Set spending limits
   - Monitor usage and costs
   - Set up auto-top-up for sessions

## Support

If you encounter issues:

1. Check this guide thoroughly
2. Review the troubleshooting section
3. Check Yellow Network status: https://status.yellow.org
4. Review transaction logs and Basescan links
5. Open an issue with:
   - Error messages
   - Transaction hashes
   - Environment details (mode, network, versions)

## Safety Reminders

**Production safety:**
- Start with small amounts (1-2 USDC)
- Test on sandbox first
- Double-check addresses
- Keep private keys secure
- Monitor transactions on Basescan
- Understand gas costs

**Good practices:**
- Run sandbox demo first
- Verify all balances before starting
- Save all transaction hashes
- Document your flow
- Set spending limits
- Use dedicated wallets for testing
